# =================================================================
# PaperCo O2C - Deploy to Azure Container Apps
# =================================================================
# What this workflow does:
#   1. Lint Python code with Ruff (fast, standard Python linter)
#   2. Run tests with pytest (ensures code works before deploying)
#   3. Build Docker image with human-readable tags (YYYYMMDD-gitsha)
#   4. Push to Azure Container Registry
#   5. Update Container App (main branch only)
#
# Authentication: Uses OIDC (no passwords stored in GitHub)
# Triggers: Push to main, pull requests, or manual dispatch

name: Deploy to Azure

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write  # Required for OIDC authentication with Azure
  contents: read   # Required to checkout repository code

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # -----------------------------------------------------------------
      # STEP 1: Get the code from this repository
      # -----------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------------
      # STEP 2: Set up Python environment for linting and testing
      # -----------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'  # Cache pip dependencies to speed up workflow

      # -----------------------------------------------------------------
      # STEP 3: Install project dependencies
      # Required for running tests (tests import your application code)
      # -----------------------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -----------------------------------------------------------------
      # STEP 4: Lint code with Ruff
      # Ruff is the standard modern Python linter (fast, zero-config)
      # Checks for: syntax errors, style issues, unused imports, etc.
      # -----------------------------------------------------------------
      - name: Lint with Ruff
        run: |
          pip install ruff
          ruff check src/ --output-format=github
        continue-on-error: true  # continue workflow if linting fails

      # -----------------------------------------------------------------
      # STEP 5: Run tests with pytest
      # Ensures your code works before building Docker image
      # Only runs tests if tests/ directory exists
      # -----------------------------------------------------------------
      - name: Test with pytest
        run: |
          pip install pytest
          if [ -d "tests" ]; then
            pytest tests/ -v
          else
            echo "No tests directory found, skipping tests"
          fi
        continue-on-error: false  # Fail workflow if tests fail

      # -----------------------------------------------------------------
      # STEP 6: Login to Azure using OIDC (passwordless authentication)
      # Uses federated identity credentials created by Terraform
      # No secrets/passwords stored - just IDs for identity verification
      # -----------------------------------------------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}          # App registration ID
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}            # Your Azure AD tenant
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }} # Target subscription

      # -----------------------------------------------------------------
      # STEP 7: Login to Azure Container Registry
      # Uses the Azure identity from previous step (no separate login needed)
      # -----------------------------------------------------------------
      - name: ACR Login
        run: az acr login --name ${{ secrets.ACR_NAME }}

      # -----------------------------------------------------------------
      # STEP 8: Build Docker image
      # Creates TWO tags:
      #   1. Date + commit SHA (e.g., 20241121-abc123) - human-readable
      #   2. 'latest' - always points to most recent build
      # This keeps old images for rollback while latest is easy to reference
      # -----------------------------------------------------------------
      - name: Build Image
        run: |
          TAG="$(date +%Y%m%d)-${{ github.sha }}"
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/paperco-app:$TAG \
                       -t ${{ secrets.ACR_LOGIN_SERVER }}/paperco-app:latest .

      # -----------------------------------------------------------------
      # STEP 9: Push image to Azure Container Registry
      # Pushes both tags (dated version + latest)
      # Both PRs and main branch push images (testing + production)
      # -----------------------------------------------------------------
      - name: Push to ACR
        run: |
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/paperco-app:$IMAGE_TAG
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/paperco-app:latest

      # -----------------------------------------------------------------
      # STEP 10: Update Container App with new image (main branch only)
      # Pull requests only build/push images (safe testing)
      # Only pushes to main actually deploy to Container App
      # -----------------------------------------------------------------
      - name: Update Container App
        if: github.ref == 'refs/heads/main'
        run: |
          az containerapp update \
            --name ${{ secrets.CONTAINER_APP_NAME }} \
            --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/paperco-app:$IMAGE_TAG

      # -----------------------------------------------------------------
      # STEP 11: Print deployment summary
      # -----------------------------------------------------------------
      - name: Summary
        if: github.ref == 'refs/heads/main'
        run: |
          echo "âœ… Deployed: paperco-app:$IMAGE_TAG"
          echo "ðŸ“¦ App: ${{ secrets.CONTAINER_APP_NAME }}"
